----item----
version: 1
id: {23F746EC-809E-4D33-9055-F33CBA1225CA}
database: master
path: /sitecore/system/Modules/PowerShell/Script Library/Functions/Execute-RemoteSitecoreScript
parent: {E22D066A-04D0-4799-9DAD-EDD9EB07C2B2}
name: Execute-RemoteSitecoreScript
master: {00000000-0000-0000-0000-000000000000}
template: {DD22F1B3-BD87-4DB2-9E7D-F7A496888D43}
templatekey: PowerShell Script

----field----
field: {B1A94FF0-6897-47C0-9C51-AA6ACB80B1F0}
name: Script
key: script
content-length: 2223

<# 
  Sitecore PowerShell Remoting.

  Sample Usage:
  Set-SitecoreSessionConfiguration 'http://localhost' 'admin' 'b'
  Execute-RemoteSitecoreScript { get-item master:\content\ } 
#>

function Set-SitecoreSessionConfiguration {
    [CmdletBinding()]
    param(
        [Parameter(Position=0, Mandatory=$true, ValueFromPipeline=$true)]
        [ValidateNotNullOrEmpty()]
        [string]$SitecoreHost,

        [Parameter(Position=1, Mandatory=$true, ValueFromPipeline=$true)]
        [ValidateNotNullOrEmpty()]
        [string]$User,
        
        [Parameter(Position=2, Mandatory=$true, ValueFromPipeline=$true)]
        [ValidateNotNullOrEmpty()]
        [string]$Password
    )
    $URI = $SitecoreHost+"/Console/Services/RemoteAutomation.asmx";
    $GLOBAL:SpeRemoteProxy = New-WebServiceProxy -Uri $URI -Class SitecorePS -Namespace webservice
    $GLOBAL:SpeRemoteUser = $User;
    $GLOBAL:SpeRemotePassword = $Password;
}

function Execute-RemoteSitecoreScript {
    [CmdletBinding()]
    param(

        [Parameter(Position=3, Mandatory=$true, ValueFromPipeline=$true)]
        [ValidateNotNullOrEmpty()]
        [ScriptBlock]$Command
    )
        $reply = $GLOBAL:SpeRemoteProxy.ExecuteScriptBlock($GLOBAL:SpeRemoteUser,$GLOBAL:SpeRemotePassword,$Command);
        $xmlString = $reply -replace "\n", "" -replace "\r",""
        $type = $type = [PSObject].Assembly.GetType("System.Management.Automation.Deserializer")
        $ctor = $type.getconstructor("instance,nonpublic", $null, @([xml.xmlreader]), $null)
        $sr = new-object System.IO.StringReader $xmlString
        $xr = new-object System.Xml.XmlTextReader $sr
        $deserializer = $ctor.invoke($xr)
        $done = $type.getmethod("Done", [System.Reflection.BindingFlags]"nonpublic,instance")
        $xmlstring | Out-File -FilePath C:\temp\result.xml
        while (!$done.invoke($deserializer, @()))
        {
            try {
                $type.InvokeMember("Deserialize", "InvokeMethod,NonPublic,Instance", $null, $deserializer, [object[]]@())
            } catch [Exception] {
                write-warning "Error while de-serializing string: $($error[0])"
                break;
            }
        }
		$xr.Close()
		$sr.Dispose()
}
----version----
language: en
version: 1
revision: 6e708e22-0c51-4dd0-b2a0-753d67e31411

----field----
field: {25BED78C-4957-4165-998A-CA1B52F67497}
name: __Created
key: __created
content-length: 15

20131117T144733
----field----
field: {8CDC337E-A112-42FB-BBB4-4143751E123F}
name: __Revision
key: __revision
content-length: 36

6e708e22-0c51-4dd0-b2a0-753d67e31411
----field----
field: {D9CF14B1-FA16-4BA6-9288-E8A174D4D522}
name: __Updated
key: __updated
content-length: 34

20131118T135750:635203798701342500
----field----
field: {BADD9CF9-53E0-4D0C-BCC0-2D784C282F6A}
name: __Updated by
key: __updated by
content-length: 14

sitecore\admin
