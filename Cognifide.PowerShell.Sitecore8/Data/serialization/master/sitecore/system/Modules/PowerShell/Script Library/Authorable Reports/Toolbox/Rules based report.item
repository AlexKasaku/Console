----item----
version: 1
id: {96341FC3-DA36-4490-9396-EE338378BFD5}
database: master
path: /sitecore/system/Modules/PowerShell/Script Library/Authorable Reports/Toolbox/Rules based report
parent: {B85E2336-26AB-47A7-B2BF-91CDE1A7E3BA}
name: Rules based report
master: {00000000-0000-0000-0000-000000000000}
template: {DD22F1B3-BD87-4DB2-9E7D-F7A496888D43}
templatekey: PowerShell Script

----field----
field: {B1A94FF0-6897-47C0-9C51-AA6ACB80B1F0}
name: Script
key: script
content-length: 4538

$ignoredFields = "__Standard values", "__Tracking", "__Source", "__Help link", "__Renderings", "__Final Renderings", "__Renderers", "__Controller", 
    "__Controller Action", "__Insert Rules", "__Preview", "__Originator", "__Quick Action Bar Validation Rules", "__Validate Button Validation Rules",
    "__Validator Bar Validation Rules", "__Skin", "__Icon", "__Enabled Views", "__Default View", "__Context Menu", "__Revision", "__Quick Actions"
    

$standardFields = [Sitecore.Data.Managers.TemplateManager]::GetTemplate([Sitecore.Configuration.Settings]::DefaultBaseTemplate, (gi .).Database).GetFields() | % { $_.Name };
                    
$rule = '<ruleset>
  <rule uid="{9CF02118-F189-49C4-9F2B-6698D64ACF23}">
    <conditions>
      <and uid="1A5916F4291F460FBC8D26530D51E760">
        <condition id="{5DE6D53E-EA62-4D17-8BDD-FEBCD80AC07B}" uid="6C620AC228E84465BF237924D9023D77" templateid="{76036F5E-CBCE-46D1-AF0A-4143F9B557AA}" />
        <condition id="{A45DBBAE-F74F-4EFE-BBD5-24395E0AF945}" uid="ED10990E15EB4E1E8FCFD33F441588A1" />
      </and>
    </conditions>
  </rule>
</ruleset>'

$root = Get-Item master:\content\
$includes = [ordered]@{ "Recursively include all children"="Recurse"; "Include Root Item"="Root" }
$include = @("Recurse", "Root")

$result = Read-Variable -Parameters `
    @{Name="root"; title="Items under"; Tooltip="Items under the selected item will be considered for evaluation"}, `
    @{Name="rule"; Editor="rule"; title="Filter rules"; Tooltip="Only items conforming to this rule will be displayed."}, `
    @{Name="include"; title="Include"; editor="checklist"; Options=$includes} `
    -Description "This dialog shows editor how a rule can be taken from an item and edited using the Read-Variable cmdlet." `
    -Title "Sample rule editing" -Width 600 -Height 600 -ShowHints

if($result -eq "cancel"){
    exit;
}

$templateFields = Find-Item -Index sitecore_master_index -Where "path.StartsWith(@0)" -WhereValues $root.Paths.Path  | 
    Initialize-Item |
    ? { Test-Rule -InputObject $_ -Rule $rule -RuleDatabase master} |
    Select -ExpandProperty TemplateId -Unique |  
    %{ New-Object Sitecore.Data.Items.TemplateItem (Get-Item master:\ -ID "$_") } | %{ $_.Fields } | 
    ?{ $ignoredFields -notcontains $_.Name } |
    select Name, Title  -Unique 

if($templateFields.Count -eq 0){
    Show-Alert "No Items matching your rule!"
    Exit
} 

$stdOptions = New-Object System.Collections.Specialized.OrderedDictionary
$stdOptions["Name"] = "Name"
$stdOptions["Display Name"] = "DisplayName"
$stdOptions["PowerShell Path"] = "ProviderPath"
$stdOptions["Template"] = "TemplateName"

$customOptions = New-Object System.Collections.Specialized.OrderedDictionary

$stdFields = @("Name", "ProviderPath", "TemplateName");
$customFields = @();

foreach($field in $templateFields){
    $title = @{$true=$field.Name; $false=$field.Title}[[string]::IsNullOrEmpty($field.Title)]
    if($standardFields -contains $field.Name){
        $stdOptions[$title] = $field.Name
    } else {
        $customOptions[$title] = $field.Name
    }
}

$titles = New-Object System.Collections.Specialized.OrderedDictionary

foreach($field in $stdOptions.Keys){
    $titles[$stdOptions[$field]] = $field
}
foreach($field in $customOptions.Keys){
    $titles[$customOptions[$field]] = $field
}

$result = Read-Variable -Parameters `
    @{ Name = "fields"; Title="Fields to include"; Options=$customOptions; Tooltip="Select fields to be shown in the report"; Editor="checklist"; Height="550px"; Tab="Custom Fields"}, `
    @{ Name = "stdFields"; Title="Fields to include"; Options=$stdOptions; Tooltip="Select fields to be shown in the report"; Editor="checklist"; Height="550px"; Tab="Standard Fields"} `
    -Description "This dialog shows fields to be displayed in the report." `
    -Title "Report fields" -Width 600 -Height 800    

if($result -eq "cancel"){
    exit;
}

$properties = @();
$fields = $fields + $stdFields;

foreach($field in $fields){
    $scr = [scriptblock]::Create('$_."' + $field + '"')
    $properties += @{Label=$titles[$field]; Expression=$scr}
}

$AuthorableData = @{ Properties = $properties; Root = $root.ProviderPath; Recurse = $recurse; Rule = $rule };
$items = Get-ChildItem $root.ProviderPath -Recurse | ? { Test-Rule -InputObject $_ -Rule $rule -RuleDatabase master}
$items | Show-ListView -Property $properties -ViewName AuthorableReport -ActionData $AuthorableData
$properties

----version----
language: en
version: 1
revision: 6359e7c7-ac5a-45c0-ad9e-4e694d1e4d8a

----field----
field: {25BED78C-4957-4165-998A-CA1B52F67497}
name: __Created
key: __created
content-length: 16

20150510T215034Z
----field----
field: {8CDC337E-A112-42FB-BBB4-4143751E123F}
name: __Revision
key: __revision
content-length: 36

6359e7c7-ac5a-45c0-ad9e-4e694d1e4d8a
----field----
field: {D9CF14B1-FA16-4BA6-9288-E8A174D4D522}
name: __Updated
key: __updated
content-length: 35

20150530T231122:635686242824533826Z
----field----
field: {BADD9CF9-53E0-4D0C-BCC0-2D784C282F6A}
name: __Updated by
key: __updated by
content-length: 14

sitecore\admin
