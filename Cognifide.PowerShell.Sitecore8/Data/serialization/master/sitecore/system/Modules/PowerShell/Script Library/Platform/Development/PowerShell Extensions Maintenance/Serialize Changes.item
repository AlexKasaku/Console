----item----
version: 1
id: {0F51A4A9-9BF9-4EF4-8B54-2ED954C6931D}
database: master
path: /sitecore/system/Modules/PowerShell/Script Library/Platform/Development/PowerShell Extensions Maintenance/Serialize Changes
parent: {01BB164C-5E8E-4C9B-941F-E5340BDD520C}
name: Serialize Changes
master: {00000000-0000-0000-0000-000000000000}
template: {DD22F1B3-BD87-4DB2-9E7D-F7A496888D43}
templatekey: PowerShell Script

----field----
field: {B1A94FF0-6897-47C0-9C51-AA6ACB80B1F0}
name: Script
key: script
content-length: 6869

$dateFields = "__Created", "__Updated", "__Valid from", "__Valid to", "__Publish", "__Unpublish", "__Archive date", "__Reminder date", "__Archive Version date"


function Convert-ToOldDate {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true, Position=0,ValueFromPipeline=$true)]
        [Sitecore.Data.Items.Item]$Item,
        
        [switch]$Recurse)

    process {
        $needsFixing = $false
        foreach($field in $dateFields){
            if($item.Fields[$field].HasValue -and $item.Fields[$field].Value.EndsWith("Z"))
            {
                $needsFixing = $true;
                break;
            }
        }
        if ($needsFixing){
            $item.Editing.BeginEdit();
            foreach($field in $dateFields){
                if($item.Fields[$field].Value.EndsWith("Z"))
                {
                    Write-Host "$($item.ProviderPath), Fixing $field, $($item.Fields[$field].Value)" -f Green
                    $item.Fields[$field].Value = $item.Fields[$field].Value.TrimEnd('Z');
                    
                }
            }
            $item.Editing.EndEdit($false, $false);
        }
        Serialize-Item $Item
        if($Recurse){
            Write-Host "$($item.ProviderPath), Going deep" -f Cyan
            Get-ChildItem $item.ProviderPath -Recurse | Convert-ToOldDate -Recurse
        }

    }
}
function Process-Item {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory=$true, Position=0,ValueFromPipeline=$true)]
        [Sitecore.Data.Items.Item]$Item,
        
        [switch]$Recurse)

    process {
        Write-Host "$($item.ProviderPath), $Recurse"
        Convert-ToOldDate -Item $Item -Recurse:$Recurse
        Serialize-Item -Item $Item -Recurse:$Recurse
    }
}


Write-Progress -Activity "Deleting old serialized item"
get-childitem $SitecoreSerializationFolder | Remove-item -Recurse
Write-Progress -Activity "Serializing items"

#Item templates
Write-Progress -Activity "Serializing Item templates" -PercentComplete 30
Get-Item 'master:\templates\Modules' | Process-Item
Get-Item 'master:\templates\Modules\PowerShell Console' | Process-Item -Recurse
Get-Item 'core:\templates\Modules' | Process-Item
Get-Item 'core:\templates\Modules\PowerShell Console' | Process-Item -Recurse

# Module Root
Write-Progress -Activity "Serializing Module Root" -PercentComplete 35
Get-Item 'master:\system\Modules\PowerShell' | Process-Item
Get-Item 'core:\system\Modules\PowerShell' | Process-Item

# Colors
Write-Progress -Activity "Serializing Console Colors" -PercentComplete 40
Get-Item 'master:\system\Modules\PowerShell\Console Colors' | Process-Item -Recurse
Get-Item 'core:\system\Modules\PowerShell\Console Colors' | Process-Item -Recurse

# Fonts
Write-Progress -Activity "Serializing Console Fonts" -PercentComplete 43
Get-Item 'master:\system\Modules\PowerShell\Fonts' | Process-Item -Recurse

# Rules Engine Rules
Write-Progress -Activity "Serializing Rules Engine Rules" -PercentComplete 45
Get-Item "master:/system/Settings/Rules/Definitions/Tags/PowerShell" | Process-Item -Recurse
Get-Item "master:/system/Settings/Rules/Definitions/Elements/PowerShell" | Process-Item -Recurse
Get-Item "master:/system/Settings/Rules/PowerShell" | Process-Item -Recurse

# Script Library
Write-Progress -Activity "Serializing Script Library" -PercentComplete 50
Get-Item 'master:\system\Modules\PowerShell\Script Library' | Process-Item
Get-ChildItem 'master:\system\Modules\PowerShell\Script Library' -recurse | Process-Item
Get-Item 'core:\system\Modules\PowerShell\Script Library' | Process-Item -Recurse
Get-ChildItem 'core:\system\Modules\PowerShell\Script Library' -recurse | Process-Item

# Settings
Write-Progress -Activity "Serializing Settings" -PercentComplete 80
Get-Item master:\system\Modules\PowerShell\Settings | Process-Item
Get-Item master:\system\Modules\PowerShell\Settings\Console | Process-Item
Get-Item 'master:\system\Modules\PowerShell\Settings\Console\All Users' | Process-Item
Get-Item master:\system\Modules\PowerShell\Settings\Context | Process-Item
Get-Item 'master:\system\Modules\PowerShell\Settings\Context\All Users' | Process-Item
Get-Item master:\system\Modules\PowerShell\Settings\Default | Process-Item
Get-Item 'master:\system\Modules\PowerShell\Settings\Default\All Users' | Process-Item
Get-Item master:\system\Modules\PowerShell\Settings\ISE | Process-Item
Get-Item 'master:\system\Modules\PowerShell\Settings\ISE\All Users' | Process-Item
Get-Item master:\system\Modules\PowerShell\Settings\RemoteAutomation | Process-Item
Get-Item 'master:\system\Modules\PowerShell\Settings\RemoteAutomation\All Users' | Process-Item

# PowerShell Applications
Write-Progress -Activity "Serializing PowerShell Applications" -PercentComplete 85
Get-Item core:\content\Applications\PowerShell | Process-Item -Recurse

# PowerShell Application Layouts
Write-Progress -Activity "Serializing PowerShell Application Layouts" -PercentComplete 87
Get-Item 'core:\layout\Layouts\Applications\PowerShell Console' | Process-Item -Recurse
Get-Item 'core:\layout\Layouts\Applications\PowerShell ISE Sheer' | Process-Item -Recurse
Get-Item 'core:\layout\Layouts\Applications\PowerShell ListView' | Process-Item -Recurse
Get-Item 'master:\layout\Layouts\PowerShell' | Process-Item -Recurse
# Start Menu icons
Write-Progress -Activity "Serializing Start Menu icons" -PercentComplete 90
Get-Item 'core:\content\Documents and settings\All users\Start menu\Right\Development Tools\PowerShell ISE' | Process-Item
Get-Item 'core:\content\Documents and settings\All users\Start menu\Right\PowerShell Console' | Process-Item
Get-Item 'core:\content\Documents and settings\All users\Start menu\Right\PowerShell Toolbox' | Process-Item
Get-Item 'core:\content\Documents and settings\All users\Start menu\Right\Reporting Tools\PowerShell Reports' | Process-Item
Get-ChildItem 'core:\content\Documents and settings\All users\Start menu\Right\Reporting Tools\PowerShell Reports' | Process-Item

# Content Editor Context Menu integration
Write-Progress -Activity "Serializing Content Editor Context Menu integration" -PercentComplete 92
Get-Item 'core:\content\Applications\Content Editor\Context Menues\Default\Edit Script' | Process-Item
Get-Item 'core:\content\Applications\Content Editor\Context Menues\Default\PowerShell Console' | Process-Item
Get-Item 'core:\content\Applications\Content Editor\Context Menues\Default\Context PowerShell Scripts' | Process-Item

# Tasks integration
Write-Progress -Activity "Serializing Content Tasks integration" -PercentComplete 100
Get-Item 'master:\system\Tasks\Commands\PowerShellScriptCommand' | Process-Item

#-name * -path "master:\system\Modules\PowerShell\Settings" -Exclude "sitecore" -Recurse
----version----
language: en
version: 1
revision: 1452332e-afd9-4524-897e-c89497e9f187

----field----
field: {25BED78C-4957-4165-998A-CA1B52F67497}
name: __Created
key: __created
content-length: 15

20130819T132011
----field----
field: {8CDC337E-A112-42FB-BBB4-4143751E123F}
name: __Revision
key: __revision
content-length: 36

1452332e-afd9-4524-897e-c89497e9f187
----field----
field: {D9CF14B1-FA16-4BA6-9288-E8A174D4D522}
name: __Updated
key: __updated
content-length: 34

20150603T133303:635689351835312500
----field----
field: {BADD9CF9-53E0-4D0C-BCC0-2D784C282F6A}
name: __Updated by
key: __updated by
content-length: 14

sitecore\admin
